name: Build & Deploy multi-services (single EC2)

on:
  push:
    branches: [ main ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    env:
      EC2_IP: ${{ secrets.EC2_IP }}
      DB_ENDPOINT: ${{ secrets.DB_ENDPOINT }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java & Maven
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y maven

      - name: Build services where required
        run: |
          echo "Starting build for all services"
          for svc in user-service product-service order-service; do
            echo "-------------------------------------------"
            echo "Building $svc..."
            if [ -f "services/$svc/pom.xml" ]; then
              mvn -f "services/$svc/pom.xml" -B clean package
            else
              echo "No pom.xml for $svc, skipping"
            fi
          done
          echo "-------------------------------------------"
          echo "Build step completed"

      - name: Recreate SSH private key file from secret
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 --decode > id_rsa
          chmod 600 id_rsa
          ls -l id_rsa

      - name: Run deploy script
        env:
          DB_ENDPOINT: ${{ secrets.DB_ENDPOINT }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          chmod +x Scripts/deploy_services.sh
          ./Scripts/deploy_services.sh "${{ secrets.EC2_IP }}" ./id_rsa "${{ secrets.DB_ENDPOINT }}"
