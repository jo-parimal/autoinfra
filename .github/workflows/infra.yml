name: Provision infra and set secrets

on:
  workflow_dispatch:

jobs:
  provision:
    runs-on: ubuntu-latest
    env:
      TF_WORKING_DIR: terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (terraform, gh)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip jq
          # Install Terraform
          wget https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip -O /tmp/terraform.zip
          sudo unzip -o /tmp/terraform.zip -d /usr/local/bin
          terraform -version
          # Install GitHub CLI
          type -p gh || (
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$( dpkg --print-architecture ) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install -y gh
          )
          gh --version

      - name: Generate SSH keypair (runner)
        run: |
          set -e
          ssh-keygen -t rsa -b 4096 -m PEM -f ./autoinfra_key -N "" -C "autoinfra_deploy_key"
          openssl rsa -in ./autoinfra_key -outform PEM -out ./autoinfra_key.pem
          chmod 600 autoinfra_key.pem
          ls -l autoinfra_key.pem autoinfra_key.pub

      - name: Prepare terraform vars file (safe heredoc)
        run: |
          mkdir -p $TF_WORKING_DIR
          echo 'public_key_path = "'"${GITHUB_WORKSPACE}"'/autoinfra_key.pub"' > $TF_WORKING_DIR/terraform.tfvars
          echo 'db_password     = "ChangeMeNow123!"' >> $TF_WORKING_DIR/terraform.tfvars
          echo 'aws_region      = "ap-south-1"' >> $TF_WORKING_DIR/terraform.tfvars
          echo "Prepared $TF_WORKING_DIR/terraform.tfvars:"
          cat $TF_WORKING_DIR/terraform.tfvars

      - name: Terraform init & apply
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-south-1
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform init -input=false
          terraform apply -auto-approve -input=false

      - name: Capture terraform outputs
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform output -json > ../tf_outputs.json
          jq . ../tf_outputs.json

      # ✅ Fixed authentication block
      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh auth setup-git
          gh auth status

      - name: Create repo secrets (EC2_IP, DB_ENDPOINT, DB_PASSWORD, EC2_SSH_KEY)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TF_OUT_JSON="../tf_outputs.json"
          EC2_IP=$(jq -r '.ec2_public_ip.value' $TF_OUT_JSON)
          DB_ENDPOINT=$(jq -r '.db_endpoint.value' $TF_OUT_JSON)
          DB_PASSWORD="ChangeMeNow123!"
          EC2_SSH_KEY="$(base64 ./autoinfra_key.pem)"
          echo "Writing secrets to repository..."
          echo "$EC2_IP" | gh secret set EC2_IP
          echo "$DB_ENDPOINT" | gh secret set DB_ENDPOINT
          echo "$DB_PASSWORD" | gh secret set DB_PASSWORD
          echo "$EC2_SSH_KEY" | gh secret set EC2_SSH_KEY_BASE64
          echo "✅ Done — EC2_IP, DB_ENDPOINT, and key stored as secrets."
